-- phpMyAdmin SQL Dump
-- version 5.2.1
-- https://www.phpmyadmin.net/
--
-- Host: 127.0.0.1
-- Generation Time: Apr 17, 2025 at 10:18 AM
-- Server version: 10.4.32-MariaDB
-- PHP Version: 8.2.12

SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
START TRANSACTION;
SET time_zone = "+00:00";


/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;

--
-- Database: `db_mamatid01`
--

-- --------------------------------------------------------

--
-- Table structure for table `appointments`
--
-- Error reading structure for table db_mamatid01.appointments: #1932 - Table &#039;db_mamatid01.appointments&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.appointments: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`appointments`&#039; at line 1

-- --------------------------------------------------------

--
-- Table structure for table `bp_monitoring`
--
-- Error reading structure for table db_mamatid01.bp_monitoring: #1932 - Table &#039;db_mamatid01.bp_monitoring&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.bp_monitoring: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`bp_monitoring`&#039; at line 1

-- --------------------------------------------------------

--
-- Table structure for table `clients`
--
-- Error reading structure for table db_mamatid01.clients: #1932 - Table &#039;db_mamatid01.clients&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.clients: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`clients`&#039; at line 1

-- --------------------------------------------------------

--
-- Table structure for table `deworming`
--
-- Error reading structure for table db_mamatid01.deworming: #1932 - Table &#039;db_mamatid01.deworming&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.deworming: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`deworming`&#039; at line 1

-- --------------------------------------------------------

--
-- Table structure for table `family_members`
--
-- Error reading structure for table db_mamatid01.family_members: #1932 - Table &#039;db_mamatid01.family_members&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.family_members: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`family_members`&#039; at line 1

-- --------------------------------------------------------

--
-- Table structure for table `family_planning`
--
-- Error reading structure for table db_mamatid01.family_planning: #1932 - Table &#039;db_mamatid01.family_planning&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.family_planning: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`family_planning`&#039; at line 1

-- --------------------------------------------------------

--
-- Table structure for table `medicines`
--
-- Error reading structure for table db_mamatid01.medicines: #1932 - Table &#039;db_mamatid01.medicines&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.medicines: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`medicines`&#039; at line 1

-- --------------------------------------------------------

--
-- Table structure for table `medicine_details`
--
-- Error reading structure for table db_mamatid01.medicine_details: #1932 - Table &#039;db_mamatid01.medicine_details&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.medicine_details: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`medicine_details`&#039; at line 1

-- --------------------------------------------------------

--
-- Table structure for table `medicine_inventory`
--
-- Error reading structure for table db_mamatid01.medicine_inventory: #1932 - Table &#039;db_mamatid01.medicine_inventory&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.medicine_inventory: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`medicine_inventory`&#039; at line 1

-- --------------------------------------------------------

--
-- Table structure for table `medicine_inventory_transactions`
--
-- Error reading structure for table db_mamatid01.medicine_inventory_transactions: #1932 - Table &#039;db_mamatid01.medicine_inventory_transactions&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.medicine_inventory_transactions: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`medicine_inventory_transactions`&#039; at line 1

-- --------------------------------------------------------

--
-- Stand-in structure for view `medicine_movement_view`
-- (See below for the actual view)
--
CREATE TABLE `medicine_movement_view` (
);

-- --------------------------------------------------------

--
-- Stand-in structure for view `medicine_stock_view`
-- (See below for the actual view)
--
CREATE TABLE `medicine_stock_view` (
);

-- --------------------------------------------------------

--
-- Table structure for table `random_blood_sugar`
--
-- Error reading structure for table db_mamatid01.random_blood_sugar: #1932 - Table &#039;db_mamatid01.random_blood_sugar&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.random_blood_sugar: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`random_blood_sugar`&#039; at line 1

-- --------------------------------------------------------

--
-- Table structure for table `tetanus_toxoid`
--
-- Error reading structure for table db_mamatid01.tetanus_toxoid: #1932 - Table &#039;db_mamatid01.tetanus_toxoid&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.tetanus_toxoid: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`tetanus_toxoid`&#039; at line 1

-- --------------------------------------------------------

--
-- Table structure for table `time_in_logs`
--
-- Error reading structure for table db_mamatid01.time_in_logs: #1932 - Table &#039;db_mamatid01.time_in_logs&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.time_in_logs: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`time_in_logs`&#039; at line 1

--
-- Triggers `time_in_logs`
--
DELIMITER $$
CREATE TRIGGER `after_time_in_insert` AFTER INSERT ON `time_in_logs` FOR EACH ROW BEGIN
  INSERT INTO `time_logs` (`user_id`, `log_date`, `time_in`, `time_out`, `total_hours`)
  VALUES (NEW.user_id, NEW.log_date, NEW.time_in, NULL, 0.00)
  ON DUPLICATE KEY UPDATE `time_in` = NEW.time_in;
END
$$
DELIMITER ;

-- --------------------------------------------------------

--
-- Table structure for table `time_logs`
--
-- Error reading structure for table db_mamatid01.time_logs: #1932 - Table &#039;db_mamatid01.time_logs&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.time_logs: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`time_logs`&#039; at line 1

-- --------------------------------------------------------

--
-- Table structure for table `time_out_logs`
--
-- Error reading structure for table db_mamatid01.time_out_logs: #1932 - Table &#039;db_mamatid01.time_out_logs&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.time_out_logs: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`time_out_logs`&#039; at line 1

--
-- Triggers `time_out_logs`
--
DELIMITER $$
CREATE TRIGGER `after_time_out_insert` AFTER INSERT ON `time_out_logs` FOR EACH ROW BEGIN
  DECLARE v_time_in TIME;
  -- Get the corresponding Time In
  SELECT `time_in` INTO v_time_in
  FROM `time_in_logs`
  WHERE `user_id` = NEW.user_id AND `log_date` = NEW.log_date;
  -- Update time_logs with Time Out and calculate total hours
  INSERT INTO `time_logs` (`user_id`, `log_date`, `time_in`, `time_out`, `total_hours`)
  VALUES (NEW.user_id, NEW.log_date, v_time_in, NEW.time_out, 
          ROUND(TIMESTAMPDIFF(SECOND, v_time_in, NEW.time_out) / 3600, 2))
  ON DUPLICATE KEY UPDATE 
    `time_out` = NEW.time_out,
    `total_hours` = ROUND(TIMESTAMPDIFF(SECOND, `time_in`, NEW.time_out) / 3600, 2);
END
$$
DELIMITER ;

-- --------------------------------------------------------

--
-- Table structure for table `users`
--
-- Error reading structure for table db_mamatid01.users: #1932 - Table &#039;db_mamatid01.users&#039; doesn&#039;t exist in engine
-- Error reading data for table db_mamatid01.users: #1064 - You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#039;FROM `db_mamatid01`.`users`&#039; at line 1

-- --------------------------------------------------------

--
-- Structure for view `medicine_movement_view`
--
DROP TABLE IF EXISTS `medicine_movement_view`;

CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `medicine_movement_view`  AS SELECT `m`.`medicine_name` AS `medicine_name`, `md`.`packing` AS `packing`, count(case when `mit`.`transaction_type` = 'OUT' then 1 end) AS `total_transactions`, sum(case when `mit`.`transaction_type` = 'OUT' then `mit`.`quantity` else 0 end) AS `total_quantity_out`, avg(case when `mit`.`transaction_type` = 'OUT' then `mit`.`quantity` else NULL end) AS `avg_quantity_per_transaction` FROM (((`medicines` `m` join `medicine_details` `md` on(`m`.`id` = `md`.`medicine_id`)) join `medicine_inventory` `mi` on(`md`.`id` = `mi`.`medicine_details_id`)) left join `medicine_inventory_transactions` `mit` on(`mi`.`id` = `mit`.`medicine_inventory_id`)) GROUP BY `m`.`medicine_name`, `md`.`packing` ;

-- --------------------------------------------------------

--
-- Structure for view `medicine_stock_view`
--
DROP TABLE IF EXISTS `medicine_stock_view`;

CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `medicine_stock_view`  AS SELECT `m`.`medicine_name` AS `medicine_name`, `md`.`packing` AS `packing`, `mi`.`batch_number` AS `batch_number`, `mi`.`quantity` AS `current_stock`, `mi`.`expiry_date` AS `expiry_date`, CASE WHEN `mi`.`quantity` <= 10 THEN 'LOW' WHEN `mi`.`quantity` <= 20 THEN 'MEDIUM' ELSE 'GOOD' END AS `stock_status`, to_days(`mi`.`expiry_date`) - to_days(curdate()) AS `days_until_expiry` FROM ((`medicine_inventory` `mi` join `medicine_details` `md` on(`mi`.`medicine_details_id` = `md`.`id`)) join `medicines` `m` on(`md`.`medicine_id` = `m`.`id`)) ;
COMMIT;

/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
